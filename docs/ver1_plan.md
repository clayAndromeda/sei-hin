# sei-hin（清貧）ver.1 仕様書

## 1. 概要

### 1.1 アプリ名
**sei-hin（清貧）**

### 1.2 コンセプト
節約のための食費記録・可視化アプリケーション。日々の食費を記録し、カレンダー表示と集計で支出を把握しやすくする。

### 1.3 対象ユーザー
開発者本人（1人用）

---

## 2. 技術スタック

| レイヤー | 技術 | バージョン目安 |
|---|---|---|
| フレームワーク | React + TypeScript | React 18+ |
| ビルドツール | Vite + vite-plugin-pwa | Vite 5+ |
| UIライブラリ | MUI (Material UI) | v5+ |
| ローカルDB | IndexedDB（Dexie.js） | Dexie 4+ |
| データ同期 | Dropbox JavaScript SDK | 最新 |
| 暗号化 | Web Crypto API（AES-GCM + PBKDF2） | ブラウザ標準 |
| ホスティング | GitHub Pages | - |
| パッケージ管理 | npm | - |

### 2.1 PWA要件
- Service Workerによるオフライン対応
- manifest.jsonによるホーム画面追加対応（Android）
- アイコン（192x192, 512x512）

---

## 3. データ設計

### 3.1 型定義

```typescript
// 1件の食費記録
interface FoodExpense {
  id: string;          // crypto.randomUUID()
  date: string;        // "YYYY-MM-DD" 形式（例: "2026-02-14"）
  amount: number;      // 金額（円、整数）
  memo: string;        // メモ（任意、空文字可。例: "昼食 コンビニ弁当"）
  createdAt: string;   // ISO 8601 datetime
  updatedAt: string;   // ISO 8601 datetime
}

// Dropboxに保存するデータ全体
interface SeihinData {
  version: 1;
  updatedAt: string;   // ISO 8601 datetime（最終更新日時）
  expenses: FoodExpense[];
}
```

### 3.2 ローカルDB（Dexie.js / IndexedDB）

```typescript
// Dexie スキーマ
const db = new Dexie("seihin");
db.version(1).stores({
  expenses: "id, date, createdAt, updatedAt",
  metadata: "key"  // { key: "lastSync", value: "2026-02-14T..." } など
});
```

### 3.3 Dropbox上のファイル構造

```
Dropbox/
  Apps/
    sei-hin/
      data.json.enc    ← AES-GCM で暗号化された SeihinData の JSON
```

---

## 4. 画面設計

### 4.1 画面一覧

アプリは3つの主要画面で構成する。ボトムナビゲーション（MUI BottomNavigation）で切り替える。

```
┌─────────────────────────────────┐
│         sei-hin（清貧）          │  ← AppBar（アプリ名 + 同期ボタン）
├─────────────────────────────────┤
│                                 │
│         メインコンテンツ          │
│                                 │
├─────────────────────────────────┤
│  📅カレンダー │ 📊サマリー │ ⚙設定 │  ← BottomNavigation
└─────────────────────────────────┘
```

### 4.2 カレンダー画面（デフォルト画面）

**目的**: 1日あたりの食費を一覧する

#### レイアウト
```
┌─────────────────────────────────┐
│  ◀  2026年2月  ▶               │  ← 月切り替え
│  今月合計: ¥32,450              │
├───┬───┬───┬───┬───┬───┬───┤
│ 日│ 月│ 火│ 水│ 木│ 金│ 土│
├───┼───┼───┼───┼───┼───┼───┤
│   │   │   │   │   │   │ 1 │
│   │   │   │   │   │   │¥850│
├───┼───┼───┼───┼───┼───┼───┤
│ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │ 8 │
│¥0 │¥1200│¥980│¥1500│¥700│¥2100│¥1800│
├───┴───┴───┴───┴───┴───┴───┤
│            ...                  │
└─────────────────────────────────┘
```

#### 仕様
- 月表示のカレンダーグリッド
- 各日付セルにその日の食費合計金額を表示
- 金額が0円の日は「¥0」と表示
- 未来の日付は金額を表示しない
- 今日の日付はハイライト表示（背景色で区別）
- ◀▶ ボタンで前月・次月に移動
- カレンダー上部に当月の合計金額を常時表示
- **日付セルをタップすると、その日の入力/編集ダイアログが開く**

### 4.3 入力/編集ダイアログ

**目的**: 食費を記録・編集・削除する

#### レイアウト
```
┌─────────────────────────────────┐
│  2026年2月14日の食費             │  ← ダイアログタイトル
├─────────────────────────────────┤
│                                 │
│  ┌──────────────────────────┐  │
│  │ ¥ [        850        ]  │  │  ← 金額入力（数値キーボード）
│  └──────────────────────────┘  │
│  ┌──────────────────────────┐  │
│  │ [  昼食 コンビニ弁当    ]  │  │  ← メモ入力（任意）
│  └──────────────────────────┘  │
│                                 │
│  [ 追加 ]                       │  ← 保存ボタン
│                                 │
│  ─── この日の記録 ───           │
│                                 │
│  ¥850  昼食 コンビニ弁当  [🗑]  │  ← 既存レコード一覧
│  ¥500  夕食 自炊         [🗑]  │
│                                 │
│  ───────────────────            │
│  合計: ¥1,350                   │
│                                 │
│              [ 閉じる ]          │
└─────────────────────────────────┘
```

#### 仕様
- MUI Dialog として実装
- 金額入力フィールド: type="number"、inputMode="numeric"（モバイルで数値キーボードが出る）
- メモ入力フィールド: type="text"、任意入力
- 「追加」ボタンで新規レコードを保存（金額が0または未入力なら追加不可）
- その日の既存レコードを一覧表示
- 各レコードに削除ボタン（🗑）。タップで確認ダイアログ → 削除
- 既存レコードのタップで編集モード（金額・メモを編集可能に）
- ダイアログ下部にその日の合計金額を表示

### 4.4 サマリー画面

**目的**: 週次・月次の食費を集計して表示する

#### レイアウト
```
┌─────────────────────────────────┐
│  [ 週次 | 月次 ]                │  ← タブ切り替え
├─────────────────────────────────┤
│                                 │
│  ── 週次表示（例） ──           │
│                                 │
│  ◀  2/10 〜 2/16  ▶            │  ← 週切り替え
│                                 │
│  月 2/10  ¥1,200               │
│  火 2/11  ¥980                 │
│  水 2/12  ¥1,500               │
│  木 2/13  ¥700                 │
│  金 2/14  ¥1,350               │
│  土 2/15  ¥2,100               │
│  日 2/16  ¥850                 │
│                                 │
│  ━━━━━━━━━━━━━━━━━━            │
│  週合計: ¥8,680                 │
│  1日平均: ¥1,240               │
│                                 │
└─────────────────────────────────┘
```

```
┌─────────────────────────────────┐
│  [ 週次 | 月次 ]                │
├─────────────────────────────────┤
│                                 │
│  ── 月次表示（例） ──           │
│                                 │
│  ◀  2026年2月  ▶               │  ← 月切り替え
│                                 │
│  月合計: ¥32,450                │
│  1日平均: ¥1,159               │
│                                 │
│  ── 週ごとの内訳 ──             │
│  第1週 (2/1-2/2):   ¥2,800    │
│  第2週 (2/3-2/9):   ¥8,200    │
│  第3週 (2/10-2/16): ¥8,680    │
│  第4週 (2/17-2/23): ¥7,900    │
│  第5週 (2/24-2/28): ¥4,870    │
│                                 │
└─────────────────────────────────┘
```

#### 仕様
- MUI Tabs で「週次」「月次」を切り替え
- **週次表示**:
  - 月曜始まり
  - ◀▶ で前週・次週に移動
  - 各曜日の合計金額をリスト表示
  - 週合計と1日平均を表示
- **月次表示**:
  - ◀▶ で前月・次月に移動
  - 月合計と1日平均を表示
  - 週ごとの内訳を表示（その月の日付に基づいて週分割）

### 4.5 設定画面

**目的**: Dropbox連携と暗号化の設定

#### 機能
- Dropbox連携: OAuth認証ボタン（連携/解除）
- 連携ステータス表示（連携済み / 未連携）
- マスターパスワード設定（初回のみ。変更機能は ver.1 では不要）
- 手動同期ボタン
- 最終同期日時の表示
- データエクスポート（JSON形式でダウンロード、バックアップ用）

---

## 5. データ同期仕様

### 5.1 同期フロー

```
[アプリ起動時]
  ↓
  ローカル（IndexedDB）からデータ読み込み → 即座に画面表示
  ↓
  バックグラウンドでDropboxからダウンロード
  ↓
  マスターパスワードで復号
  ↓
  ローカルとDropboxのデータをマージ
  ↓
  マージ結果をローカルに保存 & 暗号化してDropboxにアップロード
```

### 5.2 マージ戦略

- 各 FoodExpense は `id`（UUID）で一意に識別
- 同一IDのレコードは `updatedAt` が新しい方を採用
- 片方にしか存在しないレコードはそのまま追加
- 削除は論理削除（`deleted: true` フラグ）で同期後に物理削除

```typescript
interface FoodExpense {
  // ... 既存フィールド
  deleted?: boolean;  // 削除フラグ（同期用）
}
```

### 5.3 同期タイミング
- アプリ起動時（自動）
- 手動同期ボタン押下時
- データ変更後30秒のデバウンス（自動保存）

### 5.4 競合解決
- Dropbox API の `rev`（リビジョン）を利用
- アップロード時に `mode: { ".tag": "update", "update": lastRev }` を指定
- 競合時はダウンロードし直してマージ → 再アップロード

---

## 6. 暗号化仕様

### 6.1 暗号化フロー

```
マスターパスワード（ユーザー入力）
  ↓ PBKDF2 (SHA-256, 100,000 iterations, random salt)
  ↓
暗号化キー（AES-256-GCM）
  ↓
SeihinData JSON → AES-GCM暗号化 → data.json.enc
```

### 6.2 ファイルフォーマット（data.json.enc）

```typescript
interface EncryptedFile {
  version: 1;
  salt: string;     // Base64エンコードされた salt（16バイト）
  iv: string;       // Base64エンコードされた IV（12バイト）
  data: string;     // Base64エンコードされた暗号化データ
}
// これ自体をJSONとしてDropboxに保存
```

### 6.3 マスターパスワード管理
- マスターパスワードはどこにも保存しない
- アプリ起動時に毎回入力を求める
- セッション中はメモリ上にのみ保持
- パスワードの正当性は復号成功/失敗で判断

---

## 7. Dropbox API 連携

### 7.1 アプリ登録
- Dropbox App Console でアプリ作成
- Permission type: App folder（`Apps/sei-hin/` のみアクセス）
- OAuth 2.0 PKCE フロー（クライアントシークレット不要）

### 7.2 使用するAPI
- `files/download`: データファイルのダウンロード
- `files/upload`: データファイルのアップロード（mode: update でリビジョン管理）
- `files/get_metadata`: ファイルのメタデータ取得（rev確認用）

### 7.3 トークン管理
- アクセストークンは IndexedDB に保存
- リフレッシュトークンによる自動更新

---

## 8. UI/UXガイドライン

### 8.1 テーマ
- MUI のデフォルトテーマをベースにカスタマイズ
- プライマリカラー: 落ち着いた緑系（節約・エコのイメージ）
  - 例: `#2E7D32`（MUI green[800]）
- ダークモード対応は ver.1 では不要（ライトモードのみ）

### 8.2 レスポンシブ
- モバイルファースト（Android での利用を最優先）
- 最小幅: 320px
- カレンダーのセルは画面幅に応じて伸縮
- PC（Mac/Windows）では中央寄せ、最大幅 480px で表示

### 8.3 金額表示
- 日本円のみ対応
- 3桁区切りカンマ付き（例: ¥1,350）
- 通貨記号は「¥」

### 8.4 日付
- 日本語ロケール（曜日: 月火水木金土日）
- 週の始まりは月曜日

---

## 9. プロジェクト構成

```
sei-hin/
├── public/
│   ├── manifest.json
│   ├── favicon.ico
│   └── icons/
│       ├── icon-192.png
│       └── icon-512.png
├── src/
│   ├── main.tsx                    # エントリーポイント
│   ├── App.tsx                     # ルートコンポーネント + ナビゲーション
│   ├── components/
│   │   ├── Calendar/
│   │   │   ├── CalendarView.tsx    # カレンダー画面
│   │   │   ├── CalendarGrid.tsx    # カレンダーグリッド
│   │   │   └── DayCell.tsx         # 日付セル
│   │   ├── ExpenseDialog/
│   │   │   ├── ExpenseDialog.tsx   # 入力/編集ダイアログ
│   │   │   └── ExpenseItem.tsx     # 個別レコード表示
│   │   ├── Summary/
│   │   │   ├── SummaryView.tsx     # サマリー画面
│   │   │   ├── WeeklySummary.tsx   # 週次表示
│   │   │   └── MonthlySummary.tsx  # 月次表示
│   │   └── Settings/
│   │       └── SettingsView.tsx    # 設定画面
│   ├── hooks/
│   │   ├── useExpenses.ts          # 食費データCRUD
│   │   └── useSync.ts             # Dropbox同期ロジック
│   ├── services/
│   │   ├── db.ts                   # Dexie.js DB定義
│   │   ├── dropbox.ts             # Dropbox API ラッパー
│   │   ├── crypto.ts              # 暗号化/復号ユーティリティ
│   │   └── sync.ts                # 同期・マージロジック
│   ├── types/
│   │   └── index.ts               # 型定義
│   └── utils/
│       ├── date.ts                # 日付ユーティリティ
│       └── format.ts             # 金額フォーマットなど
├── index.html
├── vite.config.ts
├── tsconfig.json
├── package.json
└── README.md
```

---

## 10. 開発・デプロイ

### 10.1 開発コマンド
```bash
npm create vite@latest sei-hin -- --template react-ts
cd sei-hin
npm install
npm install @mui/material @emotion/react @emotion/styled @mui/icons-material
npm install dexie
npm install dropbox
npm install -D vite-plugin-pwa
npm run dev
```

### 10.2 デプロイ（GitHub Pages）
```bash
npm run build
# dist/ を GitHub Pages にデプロイ
# vite.config.ts で base: "/sei-hin/" を設定
```

### 10.3 Dropbox アプリ設定
1. https://www.dropbox.com/developers/apps にアクセス
2. 「Create app」→ Scoped access → App folder
3. アプリ名: `sei-hin`
4. Permissions: `files.content.write`, `files.content.read`
5. OAuth 2 Redirect URI に GitHub Pages の URL を追加

---

## 11. ver.1 スコープ外（将来検討）

以下は ver.1 では実装しない。将来のバージョンで検討する。

- 食費以外の支出カテゴリ
- 予算設定・予算超過アラート
- グラフ・チャート表示
- ダークモード
- データのCSVエクスポート
- 複数通貨対応
- レシート写真の添付
- 定期的な支出の自動入力
